# 四季報オンライン 株価上昇率予測パイプライン 計画

> **File:** docs/plans/01_shikiho_ml_pipeline.md
> **Date:** 2026-02-21
> **Status:** Draft

---

## 1. 背景 / ゴール

**背景:**
四季報オンラインが毎週更新する業績予想修正銘柄リスト（~1,000銘柄/週）を活用し、発表当日の後場（12:30〜）の株価動向を機械学習で予測する。現状のCSVには証券コード・社名・市場・経常/純利益修正率・時価総額・更新日・発表日のみが含まれており、株価データと補強特徴量は未取得。

**ゴール:**
3エージェント（データ更新・ML予測・レポート分析）の自動パイプラインを構築し、週次CSVを投入するだけで「11:30→終値」「12:30→終値」の株価上昇率予測レポートが出力される仕組みを作る。

---

## 2. スコープ

### In（やること）
- [ ] Agent 1: 週次CSVに株価・基本情報を付与（データ拡充）
- [ ] Agent 2: 蓄積データからMLモデルを学習・予測実行
- [ ] Agent 3: 予測結果のレポート生成 + 次週フィードバック
- [ ] 3エージェントをスクリプトで直列パイプライン化
- [ ] yfinance（.T形式）で株価・財務指標取得
- [ ] 週次データ蓄積（複数週分をマージしてモデル強化）

### Out（やらないこと）
- リアルタイム自動売買システム
- 四季報オンラインへの自動ログイン・スクレイピング（CSVは手動ダウンロード）
- 有料APIの利用
- 特定銘柄のスクリーニング推奨（投資助言行為）

---

## 3. 現状把握

**調査した情報:**
- 参照ファイル: `date/row_date/四季報_260102.xlsx` / `四季報_260102.csv`
- CSVカラム（9列）:

| カラム名 | 内容 | 備考 |
|----------|------|------|
| 証券コード | 銘柄コード | yfinance用に `{コード}.T` へ変換 |
| 社名 | 会社名 | |
| 市場 | 東P/東G/東S等 | カテゴリ特徴量として使用 |
| 経常修正率(%) | 経常利益の前回予想比修正率 | 主要特徴量 |
| 純利益修正率(%) | 純利益の前回予想比修正率 | 主要特徴量 |
| 時価総額(億円) | 時価総額 | 主要特徴量 |
| 更新日 | 四季報更新日 | 発表との差分計算に使用 |
| 備考 | 備考欄（多くNaN） | |
| 発表 | 株価取得対象日（12:00更新） | ターゲット日付 |

- 1回の週次ファイルで約1,000銘柄（1,007行）
- ファイル命名規則: `四季報_YYMMDD.csv`（YYMMDD=発表週）

**前提・制約:**
- yfinance の日本株ティッカーは `{4桁コード}.T` 形式（OK確認済）
- yfinance の分足（1m）は直近7〜30日分のみ取得可能 → **データは発表当週中に取得が必要**
- 初期はデータ不足のためMLの精度が出ない可能性がある（数週分蓄積後に本格化）
- 東証の日本株後場: 12:30〜15:30（終値）

---

## 4. 進め方（作業ステップ）

### Phase A: 環境構築

1. **ライブラリ整備** — `requirements.txt` を作成し `yfinance`, `pandas`, `scikit-learn`, `lightgbm`, `matplotlib`, `jinja2` 等をインストール
2. **プロジェクト構造整備** — 下記ディレクトリを作成
   ```
   四季報/
   ├── date/
   │   ├── row_date/      # 元CSVを毎週格納
   │   └── processed/     # 拡充済みCSVを格納（蓄積用）
   ├── models/            # 学習済みモデル保存
   ├── reports/           # 週次レポート出力
   ├── agents/
   │   ├── agent1_data_updater.py
   │   ├── agent2_ml_predictor.py
   │   └── agent3_reporter.py
   └── run_pipeline.py    # 3エージェント連携スクリプト
   ```

### Phase B: Agent 1 — データ更新エージェント

**入力:** `date/row_date/四季報_YYMMDD.csv`
**出力:** `date/processed/四季報_YYMMDD_processed.csv`

3. **株価取得モジュール** — `発表` 日の以下4時点を yfinance 1m足から取得
   - 始値（9:00頃の始値）
   - 11:30 株価（前場引け付近）
   - 12:30 株価（後場始値付近）
   - 終値（15:30）
4. **基本財務指標取得モジュール** — yfinance `Ticker.info` または `fast_info` から取得
   - 業種（sector / industry）
   - 自己資本比率（= 純資産 / 総資産）
   - PER（currentYear PER）
   - ROE（returnOnEquity）
   - 配当利回り（dividendYield）
5. **ターゲット変数計算** — 取得した株価から算出
   - `target_1130_close = (終値 - 11:30株価) / 11:30株価 * 100`
   - `target_1230_close = (終値 - 12:30株価) / 12:30株価 * 100`
6. **欠損・異常値処理** — 上場廃止・取引停止・NaN の処理ルール定義
7. **週次ファイル保存 + 蓄積マスタへのマージ** — `date/processed/master.csv` に追記

### Phase C: Agent 2 — ML予測エージェント

**入力:** `date/processed/master.csv`（蓄積済み全週分）
**出力:** `models/model_YYMMDD.pkl`, `date/processed/四季報_YYMMDD_predicted.csv`

8. **特徴量設計（初期セット）**

   | 特徴量 | 種別 | 備考 |
   |--------|------|------|
   | 経常修正率(%) | 数値 | 主要特徴量 |
   | 純利益修正率(%) | 数値 | 主要特徴量 |
   | 時価総額(億円) | 数値 | log変換検討 |
   | 市場 | カテゴリ | LabelEncoding |
   | 業種(sector) | カテゴリ | LabelEncoding |
   | 自己資本比率 | 数値 | |
   | PER | 数値 | 外れ値処理要 |
   | ROE | 数値 | |
   | 更新日→発表日の差(日) | 数値 | 発表タイムラグ |
   | 修正方向（上方/下方） | バイナリ | 経常/純利益から導出 |

9. **モデル選定・学習**
   - 第1候補: **LightGBM 回帰** — `target_1230_close` を予測
   - 第2候補: **LightGBM 回帰** — `target_1130_close` を予測
   - 精度不十分時（RMSE > 1.5% 等のしきい値）: **5クラス分類**に切り替え
     - クラス: 強気上昇(>2%) / 軽度上昇(0〜2%) / 横ばい(-0.5〜0%) / 軽度下落(-0.5〜-2%) / 強気下落(<-2%)
   - 交差検証: 時系列分割（TimeSeriesSplit n=5）

10. **ハイパーパラメータ探索** — Optuna（軽量）またはグリッドサーチで最適化（初期は省略可）

11. **予測実行** — 最新週のデータに対して予測、結果をCSVに書き込み

### Phase D: Agent 3 — レポート分析エージェント

**入力:** 予測済みCSV + モデルオブジェクト
**出力:** `reports/report_YYMMDD.html` / `.md`

12. **レポート生成**
    - モデル精度指標（MAE / RMSE / 分類ならF1）
    - 特徴量重要度グラフ
    - 予測上位20銘柄リスト（上昇期待度ランキング）
    - 前週実績との比較（予測 vs 実績）
    - 次週改善提案（特徴量追加候補・モデル変更提案）

### Phase E: パイプライン化

13. **`run_pipeline.py` 作成** — 引数にCSVパスを渡すとAgent 1→2→3を順次実行
    ```bash
    python run_pipeline.py date/row_date/四季報_260102.csv
    ```

---

## 5. 成果物（Deliverables）

| 成果物 | ファイル / 場所 | 形式 | 完了条件 |
|--------|----------------|------|---------|
| 環境定義 | `requirements.txt` | TXT | `pip install -r requirements.txt` が通る |
| データ更新Agent | `agents/agent1_data_updater.py` | Python | 1銘柄分の株価・財務指標が取得でき、CSVに書き込まれる |
| ML予測Agent | `agents/agent2_ml_predictor.py` | Python | モデルが学習され、予測値付きCSVが生成される |
| レポートAgent | `agents/agent3_reporter.py` | Python | HTMLレポートが出力される |
| パイプラインスクリプト | `run_pipeline.py` | Python | 1コマンドで3エージェントが完走する |
| 拡充済みCSV（蓄積） | `date/processed/master.csv` | CSV | 週次追記で蓄積される |
| 週次レポート | `reports/report_YYMMDD.html` | HTML | 精度指標・ランキング・特徴量重要度が含まれる |

---

## 6. リスク / 代替案

| リスク | 影響 | 確率 | 代替案 / 緩和策 |
|--------|------|------|----------------|
| yfinance 分足データが発表日から7日以上後に取得不可 | High | High | Agent1は **発表当週中（週次CSVダウンロード直後）に実行**すること。手順書に明記 |
| データ蓄積が少なくMLが機能しない（初期数週） | Medium | High | 初期は統計的な集計・可視化をメインとし、3〜5週分蓄積後にMLを本格化 |
| 銘柄コードが4桁でない（例: 135A）| Medium | Medium | `.T` 変換時に英字コードも対応するロジックを実装（yfinanceは文字列コードも対応）|
| 欠損値（財務指標NaN）が多い | Medium | Medium | 欠損率の高い特徴量は除外。KNNインピュテーションも検討 |
| 時価総額・PER等がyfinanceで最新でない | Low | Medium | 取得時刻・日付をログに記録し、おかしな値をフラグ処理 |
| 5ランク分類のクラス不均衡 | Medium | Medium | クラス重み付け（`class_weight='balanced'`）で対処 |

---

## 7. 次アクション

**この計画で次に実行すべき最初の1手:**

> `requirements.txt` を作成し、`pip install -r requirements.txt` で環境構築が完了することを確認する。その後、1銘柄（例: 7203.T）に対して yfinance で「発表日」の分足データ取得テストを実行し、11:30・12:30・終値が正しく取得できることを確認する。

**担当 / タイミング:**
- Agent 1 実装: Phase A完了後、即時着手
- 初回実データ取得: `四季報_260102.csv`（2月19日発表分）を使い、2月19日の株価データを取得（分足は2月26日頃まで取得可能）
- MLモデル本格化: 3〜5週分のデータが蓄積された時点
